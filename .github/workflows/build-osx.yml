name: Build Rasterflow (macOS ARM)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies (brew)
        run: |
          brew update
          brew install vala gtk4 libadwaita meson gobject-introspection
          brew install json-glib libgee
          
      - name: Clone babl
        run: |
          git clone https://gitlab.gnome.org/GNOME/babl.git
          cd babl
          git checkout BABL_0_1_116
          
      - name: Build and install babl
        run: |
          cd babl
          meson setup build \
            --prefix=/opt/homebrew \
            --buildtype=release
          ninja -C build
          sudo ninja -C build install

      - name: Clone GEGL
        run: |
          git clone https://gitlab.gnome.org/GNOME/gegl.git
          cd gegl
          git checkout GEGL_0_4_64

      - name: Build and install GEGL
        run: |
          cd gegl

          meson setup build \
            --prefix=/opt/homebrew \
            --buildtype=release

          ninja -C build
          sudo ninja -C build install

      - name: Clone libgtkflow
        run: |
          git clone https://github.com/flatscrew/libgtkflow

      - name: Build and install libgtkflow
        run: |
          cd libgtkflow
          meson setup build \
            --prefix=/opt/homebrew \
            -Denable_gtk3=false \
            -Denable_valadoc=false \
            --buildtype=release
          ninja -C build
          sudo ninja -C build install

      - name: Build Rasterflow
        run: |
          meson setup build \
            --buildtype=release \
            -Dc_args='-Wno-incompatible-pointer-types-discards-qualifiers -Wno-incompatible-function-pointer-types'
          meson compile -C build
          meson install -C build
          
      - name: Install gtk-mac-bundler from Git
        run: |
          git clone https://gitlab.gnome.org/GNOME/gtk-mac-bundler.git
          cd gtk-mac-bundler
          make
          sudo make install
          
      - name: Generate .app bundle + ad-hoc sign
        run: |
          set -e

          echo "=== Bundling application ==="
          gtk-mac-bundler osx-bundle/RasterFlow.bundle

          APP="osx-bundle/RasterFlow.app"

          if [ ! -d "$APP" ]; then
            echo "ERROR: RasterFlow.app not found!"
            ls -la osx-bundle
            exit 1
          fi

          echo "=== Ensuring main executable flags ==="
          chmod +x "$APP/Contents/MacOS/rasterflow" || true
          chmod +x "$APP/Contents/MacOS/rasterflow-bin" || true

          echo "=== Ad-hoc signing ==="
          codesign --force --deep --sign - "$APP"

          echo "=== Quick verification ==="
          codesign --verify --verbose=1 "$APP"

          echo "âœ… Bundle creation & signing complete."
          
      - name: Package .app into DMG
        run: |
          DMG_NAME="RasterFlow-${{ steps.version.outputs.version }}.dmg"
          APP_NAME="RasterFlow.app"

          if [ ! -d "osx-bundle/$APP_NAME" ]; then
            echo "Error: $APP_NAME not generated by bundler!"
            exit 1
          fi

          hdiutil create \
            -volname "RasterFlow" \
            -srcfolder "osx-bundle/$APP_NAME" \
            -ov \
            -format UDZO \
            "$DMG_NAME"
            
      - name: Auth check GH CLI
        run: gh auth status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old release if exists
        run: |
          gh release delete "v${{ steps.version.outputs.version }}" -y || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new release and upload asset
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            "RasterFlow-${{ steps.version.outputs.version }}.dmg" \
            --title "RasterFlow v${{ steps.version.outputs.version }} MacOS ARM" \
            --notes "Automated macOS ARM build for Rasterflow v${{ steps.version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
