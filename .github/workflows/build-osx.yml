name: Build Rasterflow (macOS ARM)

on:
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon runner

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies (brew)
        run: |
          brew update
          brew install vala gtk4 libadwaita meson gobject-introspection
          brew install babl json-glib libgee
      - name: Clone libgtkflow
        run: |
          git clone https://github.com/flatscrew/libgtkflow

      - name: Clone GEGL
        run: |
          git clone https://gitlab.gnome.org/GNOME/gegl.git
          cd gegl
          git checkout GEGL_0_4_64

      - name: Build and install GEGL
        run: |
          cd gegl

          meson setup build \
            --prefix=/opt/homebrew \
            --buildtype=release

          ninja -C build
          sudo ninja -C build install

      - name: Build and install libgtkflow
        run: |
          cd libgtkflow
          meson setup build \
            --prefix=/opt/homebrew \
            -Denable_gtk3=false \
            -Denable_valadoc=false \
            --buildtype=release
          ninja -C build
          sudo ninja -C build install

      - name: Build Rasterflow
        run: |
          meson setup build \
            --buildtype=release \
            -Dc_args='-Wno-incompatible-pointer-types-discards-qualifiers -Wno-incompatible-function-pointer-types'
          meson compile -C build
          meson install -C build
          
      - name: Install gtk-mac-bundler from Git
        run: |
          git clone https://gitlab.gnome.org/GNOME/gtk-mac-bundler.git
          cd gtk-mac-bundler
          make
          sudo make install
          
      - name: Show Homebrew tree
        run: |
          brew install tree
          echo "---- Contents of /opt/homebrew ----"
          tree -L 4 /opt/homebrew

      - name: Generate .app bundle using gtk-mac-bundler
        run: |
          gtk-mac-bundler osx-bundle/RasterFlow.bundle

      - name: Package .app into DMG
        run: |
          DMG_NAME="RasterFlow-${{ steps.version.outputs.version }}.dmg"
          APP_NAME="RasterFlow.app"

          if [ ! -d "$APP_NAME" ]; then
            echo "Error: $APP_NAME not generated by bundler!"
            ls -la .
            exit 1
          fi

          hdiutil create \
            -volname "RasterFlow" \
            -srcfolder "$APP_NAME" \
            -ov \
            -format UDZO \
            "$DMG_NAME"
            
      - name: Auth check GH CLI
        run: gh auth status
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete old release if exists
        run: |
          gh release delete "v${{ steps.version.outputs.version }}" -y || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create new release and upload asset
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            "Rasterflow-${{ steps.version.outputs.version }}.dmg" \
            --title "Rasterflow v${{ steps.version.outputs.version }}" \
            --notes "Automated macOS ARM build for Rasterflow v${{ steps.version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload CI artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: rasterflow-macos-dmg-${{ steps.version.outputs.version }}
          path: Rasterflow-${{ steps.version.outputs.version }}.dmg
