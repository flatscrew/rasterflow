name: Build Rasterflow (macOS ARM)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-macos-arm:
    runs-on: macos-14

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT

      - name: Install dependencies (brew)
        run: |
          brew update
          brew install vala gtk4 libadwaita meson gobject-introspection
          brew install json-glib libgee
          
      - name: Clone babl
        run: |
          git clone https://gitlab.gnome.org/GNOME/babl.git
          cd babl
          git checkout BABL_0_1_116
          
      - name: Build and install babl
        run: |
          cd babl
          meson setup build \
            --prefix=/opt/homebrew \
            --buildtype=release
          ninja -C build
          sudo ninja -C build install

      - name: Clone GEGL
        run: |
          git clone https://gitlab.gnome.org/GNOME/gegl.git
          cd gegl
          git checkout GEGL_0_4_64

      - name: Build and install GEGL
        run: |
          cd gegl

          meson setup build \
            --prefix=/opt/homebrew \
            --buildtype=release

          ninja -C build
          sudo ninja -C build install

      - name: Clone libgtkflow
        run: |
          git clone https://github.com/flatscrew/libgtkflow

      - name: Build and install libgtkflow
        run: |
          cd libgtkflow
          meson setup build \
            --prefix=/opt/homebrew \
            -Denable_gtk3=false \
            -Denable_valadoc=false \
            --buildtype=release
          ninja -C build
          sudo ninja -C build install

      - name: Build Rasterflow
        run: |
          meson setup build \
            --buildtype=release \
            -Dc_args='-Wno-incompatible-pointer-types-discards-qualifiers -Wno-incompatible-function-pointer-types'
          meson compile -C build

      - name: Install into staging directory
        run: meson install -C build --destdir=staging

      - name: Create tarball
        run: |
          mkdir output
          tar -czvf output/rasterflow-macos-arm64-${{ steps.version.outputs.version }}.tar.gz -C staging .

      - name: Upload artifact (GH Actions)
        uses: actions/upload-artifact@v4
        with:
          name: rasterflow-macos-arm64
          path: output/rasterflow-macos-arm64-${{ steps.version.outputs.version }}.tar.gz
          
      # - name: Auth check GH CLI
      #   run: gh auth status
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Delete old release if exists
      #   run: |
      #     gh release delete "v${{ steps.version.outputs.version }}" -y || true
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # - name: Create new release and upload asset
      #   run: |
      #     gh release create "v${{ steps.version.outputs.version }}" \
      #       "RasterFlow-${{ steps.version.outputs.version }}.dmg" \
      #       --title "RasterFlow v${{ steps.version.outputs.version }} MacOS ARM" \
      #       --notes "Automated macOS ARM build for Rasterflow v${{ steps.version.outputs.version }}"
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
