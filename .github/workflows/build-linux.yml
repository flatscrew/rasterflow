name: Build Rasterflow (Flatpak)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-flatpak:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read version
        id: version
        run: |
          echo "version=$(cat VERSION)" >> $GITHUB_OUTPUT
          
      - name: Cache Flatpak runtime
        uses: actions/cache@v4
        with:
          path: ~/.local/share/flatpak
          key: ${{ runner.os }}-flatpak-runtime-v48
          restore-keys: |
            ${{ runner.os }}-flatpak-runtime-

      - name: Install Flatpak and Builder
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak flatpak-builder git
          flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          flatpak --user install -y flathub org.gnome.Sdk//48 org.gnome.Platform//48

      - name: Build Flatpak
        run: |
          mkdir -p build-dir
          flatpak-builder --force-clean --repo=repo build-dir io.flatscrew.RasterFlow.yml

      - name: Create Flatpak bundle
        run: |
          flatpak build-bundle repo RasterFlow-${{ steps.version.outputs.version }}.flatpak io.flatscrew.RasterFlow

      - name: Upload artifact (Flatpak)
        uses: actions/upload-artifact@v4
        with:
          name: rasterflow-flatpak
          path: RasterFlow-${{ steps.version.outputs.version }}.flatpak

      - name: Delete old release if exists
        run: |
          gh release delete "v${{ steps.version.outputs.version }}" -y || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub release and upload Flatpak
        run: |
          gh release create "v${{ steps.version.outputs.version }}" \
            "rasterflow-${{ steps.version.outputs.version }}.flatpak" \
            --title "RasterFlow v${{ steps.version.outputs.version }} (Flatpak)" \
            --notes "Automated Flatpak build for RasterFlow v${{ steps.version.outputs.version }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
